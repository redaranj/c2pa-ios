name: Tests

on:
  push:
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  SCHEME: Library

jobs:
  lint:
    name: Lint
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: make lint

  test:
    name: ${{ matrix.device }} Xcode ${{ matrix.xcode }}
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        xcode: ["16.4"]
        device: ["iPhone 16 Pro", "iPhone 16"]
        ios: ["18.5"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Xcode ${{ matrix.xcode }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ matrix.xcode }}

      - name: Verify Xcode version
        run: xcodebuild -version

      - name: Ensure Simulator is Available
        run: |
          DEVICE_NAME="${{ matrix.device }}"
          IOS_VERSION="${{ matrix.ios }}"
          RUNTIME="iOS-${IOS_VERSION//./-}"

          echo "Looking for simulator: $DEVICE_NAME with iOS $IOS_VERSION"

          # List available runtimes
          echo "Available runtimes:"
          xcrun simctl list runtimes

          # List available device types
          echo "Available device types:"
          xcrun simctl list devicetypes | grep -i iphone | head -20

          # Check if the simulator already exists
          EXISTING_UDID=$(xcrun simctl list devices "$IOS_VERSION" | grep "$DEVICE_NAME" | grep -oE '[A-F0-9-]{36}' | head -1)

          if [ -n "$EXISTING_UDID" ]; then
            echo "Simulator found with UDID: $EXISTING_UDID"
          else
            echo "Simulator not found, creating one..."

            # Get the runtime identifier
            RUNTIME_ID=$(xcrun simctl list runtimes | grep "iOS $IOS_VERSION" | grep -oE 'com.apple.CoreSimulator.SimRuntime.iOS-[0-9-]+' | head -1)

            if [ -z "$RUNTIME_ID" ]; then
              echo "ERROR: iOS $IOS_VERSION runtime not found"
              echo "Available iOS runtimes:"
              xcrun simctl list runtimes | grep iOS
              exit 1
            fi

            echo "Using runtime: $RUNTIME_ID"

            # Get the device type identifier
            DEVICE_TYPE=$(xcrun simctl list devicetypes | grep "$DEVICE_NAME" | grep -oE 'com.apple.CoreSimulator.SimDeviceType.[^,)]+' | head -1)

            if [ -z "$DEVICE_TYPE" ]; then
              echo "ERROR: Device type for '$DEVICE_NAME' not found"
              echo "Available iPhone device types:"
              xcrun simctl list devicetypes | grep -i iphone
              exit 1
            fi

            echo "Using device type: $DEVICE_TYPE"

            # Create the simulator
            EXISTING_UDID=$(xcrun simctl create "$DEVICE_NAME" "$DEVICE_TYPE" "$RUNTIME_ID")
            echo "Created simulator with UDID: $EXISTING_UDID"
          fi

          # Boot the simulator if not already booted
          STATE=$(xcrun simctl list devices | grep "$EXISTING_UDID" | grep -oE '\(Booted\)|\(Shutdown\)' | tr -d '()')

          if [ "$STATE" != "Booted" ]; then
            echo "Booting simulator..."
            xcrun simctl boot "$EXISTING_UDID" || true
          fi

          # Wait for the simulator to be ready
          echo "Waiting for simulator to be ready..."
          xcrun simctl bootstatus "$EXISTING_UDID" -b

          echo "Simulator is ready!"
          xcrun simctl list devices | grep "$DEVICE_NAME"

      - name: Build Library
        run: make library DESTINATION="platform=iOS Simulator,name=${{ matrix.device }},OS=${{ matrix.ios }}"

      - name: Start Signing Server
        run: |
          make signing-server-start
          sleep 5

      - name: Wait for Server to be Ready
        run: make signing-server-wait

      - name: Verify Server Endpoints
        run: make signing-server-verify

      - name: Build & Test
        run: |
          set -o pipefail
          echo "CI environment variable: true"
          echo "Testing with server at http://127.0.0.1:8080"
          TEST_RUNNER_CI=true make test-library DESTINATION="platform=iOS Simulator,name=${{ matrix.device }},OS=${{ matrix.ios }}"

      - name: Generate test summary
        if: always()
        run: make test-summary

      - name: Upload test summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TestSummary-${{ matrix.xcode }}-${{ matrix.device }}
          path: |
            TestResults.xcresult
          if-no-files-found: warn

      - name: Export coverage LCOV
        if: success()
        run: |
          make coverage-lcov
          # Also keep the JSON for better Codecov support
          if [ -f "coverage.json" ]; then
            echo "Coverage JSON found ($(wc -c < coverage.json) bytes)"
          fi
          if [ -f "coverage.lcov" ]; then
            echo "Coverage LCOV found ($(wc -c < coverage.lcov) bytes)"
            # Create a copy with device/xcode info
            SANITIZED_DEVICE=$(echo "${{ matrix.device }}" | tr ' ()' '---')
            cp coverage.lcov "coverage-${{ matrix.xcode }}-${SANITIZED_DEVICE}.lcov"
          fi

      - name: Upload coverage report to GitHub
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.xcode }}-${{ matrix.device }}
          path: |
            coverage.lcov
            coverage.json
            coverage-*.lcov
          if-no-files-found: warn

      - name: Upload coverage report to Codecov
        if: success()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: contentauth/c2pa-ios
          files: ./coverage.lcov,./coverage.json
          flags: unittests
          name: c2pa-ios-${{ matrix.device }}
          fail_ci_if_error: false
          verbose: true

      - name: Stop Signing Server
        if: always()
        run: make signing-server-stop || true

      - name: Upload Server Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: server-logs-${{ matrix.xcode }}-${{ matrix.device }}
          path: signing-server.log
